---
- name: Kubernetes dashboard configuration file transfer
  template:
    src: 'dashboard.yaml.j2'
    dest: '/tmp/dashboard.yaml'
    owner: 'root'
    group: 'root'
    mode: '0644'

- name: Remove the Dashboard previous version by namespace delete
  command: 'kubectl delete ns kubernetes-dashboard'
  environment:
    KUBECONFIG: '/etc/kubernetes/admin.conf'
    no_proxy: '*'
  changed_when: false
  failed_when: false

- name: Enable the Kubernetes Web Dashboard
  command: 'kubectl apply -f "/tmp/dashboard.yaml"'
  environment:
    KUBECONFIG: '/etc/kubernetes/admin.conf'
    no_proxy: '*'

- name: Create Dashboard Admin Service Account
  k8s:
    state: 'present'
    kubeconfig: '/etc/kubernetes/admin.conf'
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: kubernetes-dashboard-admin
        namespace: kubernetes-dashboard
        labels:
          k8s-app: kubernetes-dashboard

- name: Create Dashboard ClusterRoleBinding
  k8s:
    state: 'present'
    kubeconfig: '/etc/kubernetes/admin.conf'
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: kubernetes-dashboard-admin
        namespace: kubernetes-dashboard
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: cluster-admin
      subjects:
      - kind: ServiceAccount
        name: kubernetes-dashboard-admin
        namespace: kubernetes-dashboard

- name: Get Dashboard access token
  shell: "kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep kubernetes-dashboard-admin | awk '{print $1}') | grep 'token:' | sed 's/.*://' | sed 's/^[ \t]*//g'"
  environment:
    KUBECONFIG: '/etc/kubernetes/admin.conf'
    no_proxy: '*'
  no_log: true
  register: kube_dashboard_token

- name: Access token outputs
  copy:
    content: '{{ kube_dashboard_token.stdout_lines[0] }}'
    dest: '/tmp/dashboard.token'
  no_log: true

- name: Remove the kubernetes dashboard configuration.
  file:
    path: '/tmp/dashboard.yaml'
    state: 'absent'
  when: kube_template_clean | bool
